<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Removed Courses from Learning Journey</title>

    <!-- Bootstrap libraries -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>
    <div id="main-container">
        <h1>Remove Courses from {{ljDetails[1]}} Learning Journey</h1>
        <h5>Skills and Courses:</h5>
        <form>
            <p v-for="skill in ljDetails[2]" v-if="skill[1].length != 0">
                <b>{{skill[0][1]}}:</b>
                <br>
                <span v-if="skill[1] != ''">
                    <span v-for="course in skill[1]">
                        <input type="checkbox" :id="course[0]" :value="course[0]" v-model="selectedCourses" 
                        v-if="course[2] != 'Completed'">
                        <input type="checkbox" :id="course[0]" :value="course[0]" v-model="selectedCourses" v-else disabled>
                        
                        <label :for="course[0]">{{course[1]}} <span v-if="course[2] != 'Register Now'">({{course[2]}})</span>
                        <span v-else>(Incomplete)</span><br></label><br>
                    </span>
                </span>
            </p><br>


            <a v-bind:href="'learningJourneyDetails.html?ljourney_id='+ljDetails[0]" class="btn btn-outline-secondary">Cancel</a><br>
            <button @click="removeCourseFromLj" class="btn btn-danger">Remove Courses</button>
        </p><br>
        </form>
 
    </div>

</body>
<script>
    const vm = new Vue({
            el: '#main-container',
            data: {
                staffId: 160212,
                selectedLj: '',
                ljDetails: '',
                courses: [],
                selectedCourses: [],
                currentTotalCourses: 0,
            },

            methods: {
                cancelEdit: function() {
                    return window.location.replace("./learningJourneyDetails.html/" + ljDetails[0]);
                },
                // remove courses from learning journey
                removeCourseFromLj: function() {
                    console.log(this.selectedCourses)
                    event.preventDefault(); 
                    if (this.selectedCourses.length == 0) {
                        return alert("Please select at least 1 course.")
                    }

                    else if (this.selectedCourses.length == this.currentTotalCourses) {
                        return alert("You must have at least 1 course in the learning journey after deletion.")
                    }
                    
                    else {

                        a = confirm("Are you sure you want to delete the selected courses from your learning journey?")
                        if (a == true) {
                        
                            axios.post('http://localhost:5000/removeCoursesFromLj', {
                                    selectedLj: this.selectedLj,
                                    selectedCourses: this.selectedCourses,
                                })
                            .then(response => {
                                    alert("You have successfully removed " + this.selectedCourses.length.toString() + " course(s) from your " + this.ljDetails[1] +" learning journey.")
                                    
                                    return window.location.replace("./learningJourneyDetails.html?ljourney_id=" + this.selectedLj);
                                })
                            .catch(error => { 
                                this.error = error.response.data.message 
                                if (this.error != '') {
                                    return alert(this.error)
                                }
                            });
                        }
                    }
                }
            },

            mounted: function() {
                let urlParams = new URLSearchParams(window.location.search);
                let myParam = urlParams.get('ljourney_id');
                axios.get('http://localhost:5000/view_LjDetails/' + myParam)
                    .then(response => {
                        this.ljDetails = response.data.data
                        let tempCourseList = []
                        for (skill of this.ljDetails[2]) {
                            skillCourseList = skill[1]
                            
                            if (skillCourseList.length != 0) {
                                if (skillCourseList.length == 1) {
                                    courseId = skillCourseList[0][0]
                                    if (!tempCourseList.includes(courseId)) {
                                        tempCourseList.push(courseId)
                                    }
                                }
                                else {
                                    for (course of skillCourseList) {
                                        courseId = course[0]
                                        if (!tempCourseList.includes(courseId)) {
                                            tempCourseList.push(courseId)
                                        }
                                    }
                                }
                            }
                        }

                        this.currentTotalCourses = tempCourseList.length
                        console.log(this.currentTotalCourses)
            
                        this.selectedLj = myParam
                    })
                    .catch(error => alert(error));
            }
        })

</script>
</html>
